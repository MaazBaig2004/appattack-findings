name: Generate LaTeX Finding from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-finding:
    if: contains(github.event.issue.labels.*.name, 'work-in-progress')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create finding file and PR
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          AUTHOR_LOGIN: ${{ github.actor }}
        run: |
          set -e

          # Extract values from issue body
          ATTACK_TYPE=$(echo "$ISSUE_BODY" | sed -n '/Attack Type/{n;p}')
          AUTHOR=$(echo "$ISSUE_BODY" | sed -n '/Author/{n;p}')
          DESCRIPTION=$(echo "$ISSUE_BODY" | sed -n '/Description/{n;p}')
          IMPACT=$(echo "$ISSUE_BODY" | sed -n '/Impact/{n;p}')

          SAFE_ATTACK=$(echo "$ATTACK_TYPE" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
          SAFE_AUTHOR=$(echo "$AUTHOR" | tr ' ' '-' | tr '[:upper:]' '[:lower:]')

          BRANCH="finding/${SAFE_ATTACK}-${SAFE_AUTHOR}-${ISSUE_NUMBER}"
          FILE="Trimester_3_2025/SampleProject/work-in-progress/${SAFE_ATTACK}-${SAFE_AUTHOR}.tex"

          git checkout -b "$BRANCH"

          mkdir -p "$(dirname "$FILE")"

          sed \
            -e "s/<<ATTACK_TYPE>>/$ATTACK_TYPE/g" \
            -e "s/<<AUTHOR>>/$AUTHOR/g" \
            -e "s|<<DESCRIPTION>>|$DESCRIPTION|g" \
            -e "s|<<IMPACT>>|$IMPACT|g" \
            templates/finding-template.tex > "$FILE"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add "$FILE"
          git commit -m "Add finding: $ATTACK_TYPE ($AUTHOR)"
          git push origin "$BRANCH"

          gh pr create \
            --title "Finding: $ATTACK_TYPE ($AUTHOR)" \
            --body "Auto-generated from issue #$ISSUE_NUMBER" \
            --base main \
            --head "$BRANCH"
