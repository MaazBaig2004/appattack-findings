name: Move finding file based on workflow label

on:
  pull_request:
    types: [labeled]

# Default permissions (least privilege)
permissions:
  contents: write
  pull-requests: read

jobs:
  enforce-single-workflow-label:
    runs-on: ubuntu-latest
    # This job needs to remove labels
    permissions:
      pull-requests: write
    steps:
      - name: Keep only the newly added workflow label
        uses: actions/github-script@v7
        with:
          script: |
            const workflowLabels = new Set([
              "work-in-progress",
              "ready-for-review",
              "feedback-to-be-addressed",
              "qa-failed",
              "ready-for-final-report",
              "archived"
            ]);

            const addedLabel = context.payload.label?.name;
            if (!addedLabel || !workflowLabels.has(addedLabel)) {
              core.info(`"${addedLabel}" is not a workflow label. Skipping enforcement.`);
              return;
            }

            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;

            const existing = (pr.labels || []).map(l => l.name);
            const toRemove = existing.filter(l => workflowLabels.has(l) && l !== addedLabel);

            core.info(`Added workflow label: ${addedLabel}`);
            core.info(`Existing workflow labels: ${existing.filter(l => workflowLabels.has(l)).join(", ") || "(none)"}`);
            core.info(`Removing: ${toRemove.join(", ") || "(none)"}`);

            for (const name of toRemove) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name });
              } catch (e) {
                core.warning(`Could not remove label "${name}": ${e.message}`);
              }
            }

  move-finding:
    needs: enforce-single-workflow-label
    runs-on: ubuntu-latest

    # Only run for workflow labels we care about
    if: |
      contains(fromJson('[
        "work-in-progress",
        "ready-for-review",
        "feedback-to-be-addressed",
        "qa-failed",
        "ready-for-final-report",
        "archived"
      ]'), github.event.label.name)

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move the finding file for this label
        env:
          LABEL_NAME: ${{ github.event.label.name }}
          BRANCH_NAME: ${{ github.head_ref }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          set -euo pipefail

          # Map label -> target directory
          case "$LABEL_NAME" in
            work-in-progress)         TARGET_DIR="work-in-progress" ;;
            ready-for-review)         TARGET_DIR="ready-for-review" ;;
            feedback-to-be-addressed) TARGET_DIR="feedback-to-be-addressed" ;;
            qa-failed)                TARGET_DIR="qa-failed" ;;
            ready-for-final-report)   TARGET_DIR="ready-for-final-report" ;;
            archived)                 TARGET_DIR="archived" ;;
            *) echo "Unhandled label: $LABEL_NAME"; exit 0 ;;
          esac

          echo "Label: $LABEL_NAME"
          echo "Target dir: $TARGET_DIR"

          git fetch origin "$BASE_REF"

          # Files changed in THIS PR compared to base (e.g. main)
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_REF"...HEAD || true)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Only consider .tex findings under Trimester_3_2025 (project can be any name, rest can be nested)
          TEX_FILES=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '^Trimester_3_2025/[^/]+/.+\.tex$' || true)

          # Require exactly ONE .tex file to be changed in the PR
          COUNT=$(echo "$TEX_FILES" | sed '/^\s*$/d' | wc -l | tr -d ' ')
          if [ "$COUNT" -eq 0 ]; then
            echo "No .tex finding file changed in this PR. Nothing to move."
            exit 0
          fi
          if [ "$COUNT" -gt 1 ]; then
            echo "More than one .tex finding file changed in this PR:"
            echo "$TEX_FILES"
            echo "Refusing to move because it's ambiguous. Keep 1 finding per PR."
            exit 1
          fi

          FILE="$TEX_FILES"
          PROJECT=$(echo "$FILE" | cut -d'/' -f2)
          FILENAME=$(basename "$FILE")
          DEST="Trimester_3_2025/$PROJECT/$TARGET_DIR/$FILENAME"

          echo "Moving $FILE â†’ $DEST"
          mkdir -p "Trimester_3_2025/$PROJECT/$TARGET_DIR"

          if [ "$FILE" != "$DEST" ]; then
            git mv "$FILE" "$DEST"
          else
            echo "File already in target folder."
            exit 0
          fi

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Move finding to $TARGET_DIR"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi
