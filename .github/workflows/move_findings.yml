name: Move finding files based on workflow labels

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: read

# This script logic is the same for all jobs:
#  - find any .tex finding file under Trimester_3_2025/*/<any-stage>/
#  - move it to the folder that matches TARGET_DIR
#  - commit + push the move

jobs:
  move-to-work-in-progress:
    if: github.event.label.name == 'work-in-progress'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
      TARGET_DIR: work-in-progress
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move finding to work-in-progress
        run: |
          # Find any .tex finding file in any stage folder
          FILES=$(git ls-files \
            "Trimester_3_2025/*/work-in-progress/*.tex" \
            "Trimester_3_2025/*/ready-for-review/*.tex" \
            "Trimester_3_2025/*/feedback-to-be-addressed/*.tex" \
            "Trimester_3_2025/*/qa-failed/*.tex" \
            "Trimester_3_2025/*/ready-for-final-report/*.tex" \
            "Trimester_3_2025/*/archived/*.tex" || true)

          echo "Found files:"
          echo "$FILES"

          if [ -z "$FILES" ]; then
            echo "No finding files found."
            exit 0
          fi

          for file in $FILES; do
            PROJECT=$(echo "$file" | cut -d'/' -f2)
            FILENAME=$(basename "$file")
            DEST="Trimester_3_2025/$PROJECT/${TARGET_DIR}/$FILENAME"

            echo "Moving $file → $DEST"
            mkdir -p "Trimester_3_2025/$PROJECT/${TARGET_DIR}"
            if [ "$file" != "$DEST" ]; then
              git mv "$file" "$DEST" || echo "Skipping $file (maybe already there)"
            else
              echo "File already in target folder."
            fi
          done

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Move finding to work-in-progress"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi

  move-to-ready-for-review:
    if: github.event.label.name == 'ready-for-review'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
      TARGET_DIR: ready-for-review
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move finding to ready-for-review
        run: |
          FILES=$(git ls-files \
            "Trimester_3_2025/*/work-in-progress/*.tex" \
            "Trimester_3_2025/*/ready-for-review/*.tex" \
            "Trimester_3_2025/*/feedback-to-be-addressed/*.tex" \
            "Trimester_3_2025/*/qa-failed/*.tex" \
            "Trimester_3_2025/*/ready-for-final-report/*.tex" \
            "Trimester_3_2025/*/archived/*.tex" || true)

          echo "Found files:"
          echo "$FILES"

          if [ -z "$FILES" ]; then
            echo "No finding files found."
            exit 0
          fi

          for file in $FILES; do
            PROJECT=$(echo "$file" | cut -d'/' -f2)
            FILENAME=$(basename "$file")
            DEST="Trimester_3_2025/$PROJECT/${TARGET_DIR}/$FILENAME"

            echo "Moving $file → $DEST"
            mkdir -p "Trimester_3_2025/$PROJECT/${TARGET_DIR}"
            if [ "$file" != "$DEST" ]; then
              git mv "$file" "$DEST" || echo "Skipping $file (maybe already there)"
            else
              echo "File already in target folder."
            fi
          done

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Move finding to ready-for-review"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi

  move-to-feedback:
    if: github.event.label.name == 'feedback-to-be-addressed'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
      TARGET_DIR: feedback-to-be-addressed
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move finding to feedback-to-be-addressed
        run: |
          FILES=$(git ls-files \
            "Trimester_3_2025/*/work-in-progress/*.tex" \
            "Trimester_3_2025/*/ready-for-review/*.tex" \
            "Trimester_3_2025/*/feedback-to-be-addressed/*.tex" \
            "Trimester_3_2025/*/qa-failed/*.tex" \
            "Trimester_3_2025/*/ready-for-final-report/*.tex" \
            "Trimester_3_2025/*/archived/*.tex" || true)

          echo "Found files:"
          echo "$FILES"

          if [ -z "$FILES" ]; then
            echo "No finding files found."
            exit 0
          fi

          for file in $FILES; do
            PROJECT=$(echo "$file" | cut -d'/' -f2)
            FILENAME=$(basename "$file")
            DEST="Trimester_3_2025/$PROJECT/${TARGET_DIR}/$FILENAME"

            echo "Moving $file → $DEST"
            mkdir -p "Trimester_3_2025/$PROJECT/${TARGET_DIR}"
            if [ "$file" != "$DEST" ]; then
              git mv "$file" "$DEST" || echo "Skipping $file (maybe already there)"
            else
              echo "File already in target folder."
            fi
          done

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Move finding to feedback-to-be-addressed"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi

  move-to-qa-failed:
    if: github.event.label.name == 'qa-failed'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
      TARGET_DIR: qa-failed
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move finding to qa-failed
        run: |
          FILES=$(git ls-files \
            "Trimester_3_2025/*/work-in-progress/*.tex" \
            "Trimester_3_2025/*/ready-for-review/*.tex" \
            "Trimester_3_2025/*/feedback-to-be-addressed/*.tex" \
            "Trimester_3_2025/*/qa-failed/*.tex" \
            "Trimester_3_2025/*/ready-for-final-report/*.tex" \
            "Trimester_3_2025/*/archived/*.tex" || true)

          echo "Found files:"
          echo "$FILES"

          if [ -z "$FILES" ]; then
            echo "No finding files found."
            exit 0
          fi

          for file in $FILES; do
            PROJECT=$(echo "$file" | cut -d'/' -f2)
            FILENAME=$(basename "$file")
            DEST="Trimester_3_2025/$PROJECT/${TARGET_DIR}/$FILENAME"

            echo "Moving $file → $DEST"
            mkdir -p "Trimester_3_2025/$PROJECT/${TARGET_DIR}"
            if [ "$file" != "$DEST" ]; then
              git mv "$file" "$DEST" || echo "Skipping $file (maybe already there)"
            else
              echo "File already in target folder."
            fi
          done

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Move finding to qa-failed"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi

  move-to-ready-for-final:
    if: github.event.label.name == 'ready-for-final-report'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
      TARGET_DIR: ready-for-final-report
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move finding to ready-for-final-report
        run: |
          FILES=$(git ls-files \
            "Trimester_3_2025/*/work-in-progress/*.tex" \
            "Trimester_3_2025/*/ready-for-review/*.tex" \
            "Trimester_3_2025/*/feedback-to-be-addressed/*.tex" \
            "Trimester_3_2025/*/qa-failed/*.tex" \
            "Trimester_3_2025/*/ready-for-final-report/*.tex" \
            "Trimester_3_2025/*/archived/*.tex" || true)

          echo "Found files:"
          echo "$FILES"

          if [ -z "$FILES" ]; then
            echo "No finding files found."
            exit 0
          fi

          for file in $FILES; do
            PROJECT=$(echo "$file" | cut -d'/' -f2)
            FILENAME=$(basename "$file")
            DEST="Trimester_3_2025/$PROJECT/${TARGET_DIR}/$FILENAME"

            echo "Moving $file → $DEST"
            mkdir -p "Trimester_3_2025/$PROJECT/${TARGET_DIR}"
            if [ "$file" != "$DEST" ]; then
              git mv "$file" "$DEST" || echo "Skipping $file (maybe already there)"
            else
              echo "File already in target folder."
            fi
          done

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Move finding to ready-for-final-report"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi

  move-to-archived:
    if: github.event.label.name == 'archived'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref }}
      TARGET_DIR: archived
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Move finding to archived
        run: |
          FILES=$(git ls-files \
            "Trimester_3_2025/*/work-in-progress/*.tex" \
            "Trimester_3_2025/*/ready-for-review/*.tex" \
            "Trimester_3_2025/*/feedback-to-be-addressed/*.tex" \
            "Trimester_3_2025/*/qa-failed/*.tex" \
            "Trimester_3_2025/*/ready-for-final-report/*.tex" \
            "Trimester_3_2025/*/archived/*.tex" || true)

          echo "Found files:"
          echo "$FILES"

          if [ -z "$FILES" ]; then
            echo "No finding files found."
            exit 0
          fi

          for file in $FILES; do
            PROJECT=$(echo "$file" | cut -d'/' -f2)
            FILENAME=$(basename "$file")
            DEST="Trimester_3_2025/$PROJECT/${TARGET_DIR}/$FILENAME"

            echo "Moving $file → $DEST"
            mkdir -p "Trimester_3_2025/$PROJECT/${TARGET_DIR}"
            if [ "$file" != "$DEST" ]; then
              git mv "$file" "$DEST" || echo "Skipping $file (maybe already there)"
            else
              echo "File already in target folder."
            fi
          done

          if git status --porcelain | grep .; then
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git commit -m "Archive finding"
            git push origin HEAD:"$BRANCH_NAME"
          else
            echo "No changes to commit."
          fi
